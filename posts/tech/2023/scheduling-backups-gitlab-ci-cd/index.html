<!doctype html><html><head><title>Scheduling backups with GitLab CI/CD</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link rel=stylesheet href=/google-fonts/Mulish/mulish.css><link rel=stylesheet href=/fontawesome/css/all.min.css><link rel=icon type=image/png href=/images/mjn-logo_huc94cd2164fb0a8cc0029e94778229d7b_288620_42x0_resize_box_3.png><meta property="og:title" content="Scheduling backups with GitLab CI/CD"><meta property="og:description" content="How to schedule backups on your server using GitLab CI/CD pipelines"><meta property="og:type" content="article"><meta property="og:url" content="https://michjnich.github.io/posts/tech/2023/scheduling-backups-gitlab-ci-cd/"><meta property="og:image" content="https://michjnich.github.io/posts/tech/2023/2023_03_11_scheduling_backups_from_gitlab_cicd/images/backup.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-11T12:00:00+01:00"><meta property="article:modified_time" content="2023-03-11T12:00:00+01:00"><meta name=description content="How to schedule backups on your server using GitLab CI/CD pipelines"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://michjnich.github.io/posts/tech/2023/2023_03_11_scheduling_backups_from_gitlab_cicd/images/backup.jpg"><meta name=twitter:title content="Scheduling backups with GitLab CI/CD"><meta name=twitter:description content="How to schedule backups on your server using GitLab CI/CD pipelines"></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/><img src=/images/mjn-logo.svg alt=Logo>
Michael J. Nicholson</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div><img src=/images/mjn-logo.svg class=d-none id=main-logo alt=Logo>
<img src=/images/mjn-logo_huc94cd2164fb0a8cc0029e94778229d7b_288620_42x0_resize_box_3.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/tech/>Tech</a><ul class=active><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/tech/2023/>2023</a><ul class=active><li><a class=active href=/posts/tech/2023/scheduling-backups-gitlab-ci-cd/ title="Backup with GitLab CI/CD">Backup with GitLab CI/CD</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/tech/2022/>2022</a><ul><li><a href=/posts/tech/2022/2022_09_17_debug_django_in_docker/ title="Debug Django in Docker">Debug Django in Docker</a></li><li><a href=/posts/tech/2022/2022_04_06_duckduckgo_bangs/ title="DuckDuckGo !bangs">DuckDuckGo !bangs</a></li><li><a href=/posts/tech/2022/2022_12_08_email_inbox_for_django_development/ title="Email inbox for Django">Email inbox for Django</a></li><li><a href=/posts/tech/2022/2022_09_21_colourblind_settings_for_git/ title="Git for the colourblind">Git for the colourblind</a></li><li><a href=/posts/tech/2022/2022_04_03_welcome_to_v2/ title="michjnich.com v2">michjnich.com v2</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/tech/2021/>2021</a><ul><li><a href=/posts/tech/2021/2021_02_25_remote_working/ title="Remote working">Remote working</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/tech/2020/>2020</a><ul><li><a href=/posts/tech/2020/2020_12_23_legacy_monolith/ title="Legacy monolith">Legacy monolith</a></li></ul></li></ul></li><li><a href=/posts/writing/ title=Writing>Writing</a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/posts/tech/2023/scheduling-backups-gitlab-ci-cd/images/backup.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/michjnich_hu196abb93d882ab659dc50e489200e798_20228_120x120_fit_q75_box.jpg alt="Author Image"><h5 class=author-name>Michael J. Nicholson</h5><p>Saturday, March 11, 2023</p></div><div class=title><h1>Scheduling backups with GitLab CI/CD</h1></div><div class=post-content id=post-content><p>I recently created a small Django project to manage a rolling menu for our family meals. It&rsquo;s not a large project. I&rsquo;m hosting it on a Digital Ocean droplet (for which I pay $4/month, and it runs more than one project), and I have a free-tier Postgres database with <a href=https://www.elephantsql.com>ElephantSQL</a>. Because this is only a personal project, I didn&rsquo;t want to pay for the database or any backups there (though my experience so far of ElephantSQL is positive, and for a larger project I may well do this! It&rsquo;s very easy to spin up a new DB instance with them).</p><p>First, I thought I would just use a crontab job to run <code>python manage.py dumpdata ...</code> on a regular basis. This, I&rsquo;m sure, would have worked just fine. At the same time though it decouples the solution from the repository.</p><p>So, then I had another idea: GitLab pipelines allow for the scheduling of a pipeline. This is free functionality (as long as you don&rsquo;t want to schedule a <em>lot</em> of stuff!). And yes, it worked!</p><h2 id=step-1---create-a-backup-script>Step 1 - Create a backup script</h2><p>First, I wanted to run a little more than just the data dump. Ideally I would clean up old backups and keep some kind of grandfather/father/son system. So I wrote a quick bash script to manage this. It&rsquo;s overly implistic, and I may refactor it to use <code>logrotate</code> at some point, but for the moment, this does the job.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>set -e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PROJECT_DIR<span style=color:#f92672>=</span>/apps/&lt;project&gt;
</span></span><span style=display:flex><span>VENV_NAME<span style=color:#f92672>=</span>&lt;project venv name&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TODAY<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +<span style=color:#e6db74>&#34;%Y%m%d&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>TODAY_TS<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>TODAY<span style=color:#e6db74>}</span>_<span style=color:#66d9ef>$(</span>date +<span style=color:#e6db74>&#34;%H%M%S&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>TODAY_DAY_NO<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#34;+%u&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>CURRENT_DAY<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>TODAY:6:2<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>CURRENT_MONTH<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>TODAY:4:2<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>CURRENT_YEAR<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>TODAY:0:4<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>LAST_DAY_OF_MONTH<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>cal <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>CURRENT_MONTH<span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span>CURRENT_YEAR<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> | awk <span style=color:#e6db74>&#39;NF {DAYS = $NF}; END {print DAYS}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DAILY_BACKUP_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;db_daily_</span><span style=color:#e6db74>${</span>TODAY_TS<span style=color:#e6db74>}</span><span style=color:#e6db74>.json&#34;</span>
</span></span><span style=display:flex><span>BACKUP_DIR<span style=color:#f92672>=</span>/apps/data_backups/&lt;project&gt;/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BACKUP_RETENTION_DAILY<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>BACKUP_RETENTION_WEEKLY<span style=color:#f92672>=</span><span style=color:#66d9ef>$((</span><span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>7</span><span style=color:#66d9ef>))</span>
</span></span><span style=display:flex><span>BACKUP_RETENTION_MONTHLY<span style=color:#f92672>=</span><span style=color:#66d9ef>$((</span><span style=color:#ae81ff>6</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>30</span><span style=color:#66d9ef>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cd $PROJECT_DIR
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>printf <span style=color:#e6db74>&#34;\n*** Activate virtual env: %s\n&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>VENV_NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>pyenv activate $VENV_NAME
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>printf <span style=color:#e6db74>&#34;\n*** Running data export\n&#34;</span>
</span></span><span style=display:flex><span>python manage.py dumpdata --exclude auth.permission --exclude contenttypes --exclude admin.LogEntry --exclude sessions --indent <span style=color:#ae81ff>2</span> &gt; <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_DIR<span style=color:#e6db74>}${</span>DAILY_BACKUP_FILE<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>((</span> TODAY_DAY_NO <span style=color:#f92672>==</span> <span style=color:#ae81ff>7</span> <span style=color:#f92672>))</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>Â  Â  printf <span style=color:#e6db74>&#34;\n*** SUNDAY - Copying to weekly backup\n&#34;</span>
</span></span><span style=display:flex><span>Â  Â  cp <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_DIR<span style=color:#e6db74>}${</span>DAILY_BACKUP_FILE<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>db_weekly_</span><span style=color:#e6db74>${</span>TODAY_TS<span style=color:#e6db74>}</span><span style=color:#e6db74>.json&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>((</span> CURRENT_DAY <span style=color:#f92672>==</span> LAST_DAY_OF_MONTH <span style=color:#f92672>))</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>Â  Â  printf <span style=color:#e6db74>&#34;\n*** END OF MONTH - Copying to monthly backup\n&#34;</span>
</span></span><span style=display:flex><span>Â  Â  cp <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_DIR<span style=color:#e6db74>}${</span>DAILY_BACKUP_FILE<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>db_monthly_</span><span style=color:#e6db74>${</span>TODAY_TS<span style=color:#e6db74>}</span><span style=color:#e6db74>.json&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>printf <span style=color:#e6db74>&#34;\n*** Cleaning old backup files\n&#34;</span>
</span></span><span style=display:flex><span>find <span style=color:#e6db74>${</span>BACKUP_DIR<span style=color:#e6db74>}</span>db_daily_* -mtime +<span style=color:#e6db74>${</span>BACKUP_RETENTION_DAILY<span style=color:#e6db74>}</span> -exec rm <span style=color:#f92672>{}</span> <span style=color:#ae81ff>\;</span>
</span></span><span style=display:flex><span>find <span style=color:#e6db74>${</span>BACKUP_DIR<span style=color:#e6db74>}</span>db_weekly_* -mtime +<span style=color:#e6db74>${</span>BACKUP_RETENTION_WEEKLY<span style=color:#e6db74>}</span> -exec rm <span style=color:#f92672>{}</span> <span style=color:#ae81ff>\;</span> 2&gt;/dev/null <span style=color:#f92672>||</span> true
</span></span><span style=display:flex><span>find <span style=color:#e6db74>${</span>BACKUP_DIR<span style=color:#e6db74>}</span>db_monthly_* -mtime +<span style=color:#e6db74>${</span>BACKUP_RETENTION_MONTHLY<span style=color:#e6db74>}</span> -exec rm <span style=color:#f92672>{}</span> <span style=color:#ae81ff>\;</span> 2&gt;/dev/null <span style=color:#f92672>||</span> true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set +e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exit <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>A few notes:</p><ul><li>I am using <code>pyenv</code> to manage virtual environments. You may have a different solution and need to tweak the script accordingly.</li><li><code>set -e</code> will throw an exception and stop processing if there is an error.</li><li>The DO droplet did not come with <code>cal</code> installed, so I needed to <code>sudo apt install ncal</code> to get the last day of the month this way.</li><li>The retention values are in number of days. This is because I use <code>find</code> with <code>mtime</code> to locate the old files, rather than going off the timestamp in the filename.</li><li>I&rsquo;m using <code>pyenv</code> to manage my python versions and environments (yes, my app is called &ldquo;menu&rdquo;).</li><li>This script will run in a non-interactive ssh shell, so don&rsquo;t rely on env vars being available. You may need to specify them in your script or change your <code>.bashrc</code> a little (other shells work differently).</li></ul><h4 id=a-note-on-env-vars-and-bashrc>A note on env vars and <code>.bashrc</code></h4><p>Because this script will get run when logged into your server via ssh in non-interactive mode, you will not necessarily have access to all environment vars and other settings contained in your <code>.bashrc</code>. Exactly how this works differs a little across different flavours of Linux. On my Digital Ocean Ubuntu droplet, <code>.bashrc</code> runs, but most of it is ignored becuase of the following code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># If not running interactively, don&#39;t do anything</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> $- in
</span></span><span style=display:flex><span>    *i*<span style=color:#f92672>)</span> ;;
</span></span><span style=display:flex><span>      *<span style=color:#f92672>)</span> <span style=color:#66d9ef>return</span>;;
</span></span><span style=display:flex><span><span style=color:#66d9ef>esac</span>
</span></span></code></pre></div><p>Some Linux flavours may not run <code>.bashrc</code> at all. In my case, all I really need is for <code>pyenv</code> to work so I can activate my project environment, and for the environment vars necessary for that project to be available.</p><p>To allow this, I moved up the <code>pyenv</code> initialisation and loaded in my project settings at the top of the <code>.bashrc</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># -- PYENV --</span>
</span></span><span style=display:flex><span>export PYENV_ROOT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$HOME<span style=color:#e6db74>/.pyenv&#34;</span>
</span></span><span style=display:flex><span>command -v pyenv &gt;/dev/null <span style=color:#f92672>||</span> export PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$PYENV_ROOT<span style=color:#e6db74>/bin:</span>$PATH<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>eval <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>pyenv init -<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Load pyenv-virtualenv automatically</span>
</span></span><span style=display:flex><span>eval <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>pyenv virtualenv-init -<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># -- LOAD PROJECT ENV VARS --</span>
</span></span><span style=display:flex><span>set -o allexport
</span></span><span style=display:flex><span>source ~/appconfig/.env_project1
</span></span><span style=display:flex><span>source ~/appconfig/.env_project2
</span></span><span style=display:flex><span>set +o allexport
</span></span></code></pre></div><p>As you can see, I am running more than one project on this server, so I have seperate <code>.env</code> files for environment vars for each project.</p><blockquote><p>ðŸ’¡ Note that these changes are needed for the user that runs our project. If you have different users for each project, make sure you are configuring the correct user.</p></blockquote><h2 id=step-2---configure-ssh>Step 2 - Configure SSH</h2><p>For GitLab to connect to your server at all it needs to authenticate itself. This is handled via an SSH key. <a href=https://docs.gitlab.com/ee/ci/ssh_keys/>GitLab has good documentation on this</a>, so I won&rsquo;t go into too much detail here, but the basic steps are:</p><ol><li>Create an SSH key on your local machine using <code>ssh-keygen</code>.</li><li>Add the <code>$SSH_HOST</code> (IP address of your server), <code>$SSH_PRIVATE_KEY</code> (that you generated in the previous step), and <code>$SSH_USER</code> (the user that owns the applicatiion on your server, and that can do a deploy) environment variables to your repository under Settings > CI/CD > Variables.</li><li>Add the public key file to your server. I called mine <code>id_ed25519_gitlab_ci.pub</code> for clarity.</li></ol><p>At this point, GitLab CI/CD has what it needs to connect to your server.</p><h2 id=step-3---add-a-ci-backup-job>Step 3 - Add a CI backup job</h2><p>Once GitLab CI/CD can authenticate itself and connect to your server, you can ask it to do so in the configutation. I have added a seperate <code>backup</code> stage for clarity.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>stages</span>:
</span></span><span style=display:flex><span>Â  - <span style=color:#ae81ff>backup</span>
</span></span><span style=display:flex><span>Â  - <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>.script_config</span>: <span style=color:#75715e>&amp;script_config</span>
</span></span><span style=display:flex><span>Â  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>ubuntu:latest</span>
</span></span><span style=display:flex><span>Â  <span style=color:#f92672>before_script</span>:
</span></span><span style=display:flex><span>Â  Â  - <span style=color:#ae81ff>apt-get -yq update</span>
</span></span><span style=display:flex><span>Â  Â  - <span style=color:#ae81ff>apt-get -yqq install ssh</span>
</span></span><span style=display:flex><span>Â  Â  - <span style=color:#ae81ff>install -m 600 -D /dev/null ~/.ssh/id_ed25519</span>
</span></span><span style=display:flex><span>Â  Â  - <span style=color:#ae81ff>echo &#34;$SSH_PRIVATE_KEY&#34; | base64 -d &gt; ~/.ssh/id_ed25519</span>
</span></span><span style=display:flex><span>Â  Â  - <span style=color:#ae81ff>ssh-keyscan -H $SSH_HOST &gt; ~/.ssh/known_hosts</span>
</span></span><span style=display:flex><span>Â  <span style=color:#f92672>after_script</span>:
</span></span><span style=display:flex><span>Â  Â  - <span style=color:#ae81ff>rm -rf ~/.ssh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>backup</span>:
</span></span><span style=display:flex><span>Â  <span style=color:#f92672>&lt;&lt;</span>: <span style=color:#75715e>*script_config</span>
</span></span><span style=display:flex><span>Â  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>backup</span>
</span></span><span style=display:flex><span>Â  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>Â  Â  - <span style=color:#ae81ff>schedules</span>
</span></span><span style=display:flex><span>Â  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>Â  Â  - <span style=color:#ae81ff>ssh $SSH_USER@$SSH_HOST &#34;cd $WORK_DIR &amp;&amp; . ./scripts/backup.sh&#34;</span>
</span></span></code></pre></div><p>Here, I have factored out the basic connection functionality to <code>.script_config</code>. This is because I use a similar script to deploy my project via CI/CD, and that also needs to conect to the server to do so.</p><p>The <code>before_script</code> section of <code>.script_config</code> here is doing the following:</p><ul><li>Installing <code>ssh</code>.</li><li>Copying the private key from the GitLab CI/CD variable into the running Ubuntu container.</li><li>Adding the host to <code>known_hosts</code></li></ul><p>Likewise the <code>after_script</code> section is cleaning up this to ensure no secure information is left behind in artefacts.</p><p>The <code>backup</code> section itself will only run as a scheduled job, and simply runs the script you created in step</p><blockquote><p>ðŸ’¡ Note that the variable <code>$WORK_DIR</code> needs adding to your CI/CD variables, and should correspond to the root directory of your project on the server.</p></blockquote><h2 id=step-4---add-the-scheduled-job>Step 4 - Add the scheduled job</h2><p>This final step is the simplest. Under CI/CD > Schedules add a new pipeline. You will need to provide the following information:</p><p>Description: A short description of the task that lets you identify the job later.
Interval pattern: There are simple selection options here, or you can define it using the <a href=https://crontab.guru>standard pattern for crontab jobs</a>.
Crontab timezone: The timezone to apply to the interval pattern.
Target branch or tag: The branch or tag that should be used for the job. Most likely <code>main</code>.
Variables: Any variables that are specifically required for this job.</p><blockquote><p>ðŸ’¡ You could set up the SSH vars here if you like and have them only apply to the pipeline. Because my server is only a staging server, run tasks on different projects using the same user, so I have my vars at the project level. If you have different users it may make sense to have them here.</p></blockquote><h2 id=conclusion>Conclusion</h2><p>And that&rsquo;s it, you now have a scheduled task that will dump the database to a <code>.json</code> file. Becasue I run multiple projects on the same server (mostly staging environments for different things), I can then pay Digital Ocean for a single backup for the one server, which will give me backups for all the data, rather than paying for individual database backups for each project.</p><p>This solution is almost certainly not fit for use in a high-security production environment, but for personal projects, staging environemnts with fake data in them etc. it is a good way of backing up multiple projects with a single backup and controlling it all via GitLab configuration.</p></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"></div></div><hr><div class="row next-prev-navigator"><div class="col-md-12 next-article"><a href=/posts/tech/2022/2022_09_17_debug_django_in_docker/ title="Debugging Django in a Docker container" class="btn btn-outline-info"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>Debugging Django in a Docker container</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#step-1---create-a-backup-script>Step 1 - Create a backup script</a><ul><li></li></ul></li><li><a href=#step-2---configure-ssh>Step 2 - Configure SSH</a></li><li><a href=#step-3---add-a-ci-backup-job>Step 3 - Add a CI backup job</a></li><li><a href=#step-4---add-the-scheduled-job>Step 4 - Add the scheduled job</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://michjnich.github.io#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://michjnich.github.io#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://michjnich.github.io#experiences>Experience</a></li><li class=nav-item><a class=smooth-scroll href=https://michjnich.github.io#projects>Projects</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:michjnich.com@outlook.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>michjnich.com@outlook.com</span></a></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">Â© 2022 Copyright, Michael J. Nicholson</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script>
<script type=text/javascript src=/js/popper.min.js></script>
<script type=text/javascript src=/js/bootstrap.min.js></script>
<script type=text/javascript src=/js/navbar.js></script>
<script type=text/javascript src=/js/plyr.js></script>
<script type=text/javascript src=/js/main.js></script>
<script type=text/javascript>var sc_project=12797075,sc_invisible=1,sc_security="dff93a2a"</script><script type=text/javascript src=https://www.statcounter.com/counter/counter.js async></script><noscript><div class=statcounter><a title="Web Analytics
    Made Easy - Statcounter" href=https://statcounter.com/ target=_blank><img class=statcounter src=https://c.statcounter.com/12797075/0/dff93a2a/1/ alt="Web Analytics Made Easy - Statcounter" referrerpolicy=no-referrer-when-downgrade></a></div></noscript><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script>
<script src=/js/single.js></script>
<script>hljs.initHighlightingOnLoad()</script></body></html>